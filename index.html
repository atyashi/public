<!DOCTYPE HTML>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Geolocation Sample</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
<script type="text/javascript">

// watchPosition()の戻り値。この戻り値をclearWatch()に渡すことでwatch(監視)を停止させる。
var watchId = null;

// 位置情報監視開始
function start(){
    // watchIdが設定されているかをチェック
    if (watchId == null) {
        // 設定されていない → 監視中ではないのでwatch開始
        
        // メッセージ表示領域をクリア
        document.getElementById("message").innerHTML = "";

        // ブラウザがGeolocation APIに対応しているかをチェック
        if (navigator.geolocation) {
            // 対応している → 位置情報監視開始
            // 取得成功時にsuccessCallback()、そして取得失敗時にerrorCallback()がコールされる
            // optionsはgetCurrentPosition()に渡す設定値
            watchId = navigator.geolocation.watchPosition(successCallback, errorCallback , options);
            
            // メッセージを表示。↑は非同期処理なので、直ぐにメッセージが表示される
            document.getElementById("message").innerHTML = "API実行<br />";
        } else {
            // 対応していない → alertを表示するのみ
            alert("Geolocation not supported in this browser");
        }
    }
}

// 位置情報監視停止
function stop(){
    // watchIdが設定されているかをチェック
    if (watchId != null) {
        // 設定されている → 監視中なのでwatch停止
        navigator.geolocation.clearWatch(watchId);
        
        // watchIdを空にする
        watchId = null;
        
        // メッセージを表示
        document.getElementById("message").innerHTML += "clearWatch実行(watch停止)<br />";
    }
}

function init() {
    //地図を表示するdiv要素のidを設定
    var map = L.map('map');
    //地図の中心とズームレベルを指定
    map.setView([35.40, 136], 10);
    //表示するタイルレイヤのURLとAttributionコントロールの記述を設定して、地図に追加する
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
    }).addTo(map);
}
</script>
</head>
<body onload="init()">
    <div id="map" style="width:600px;height:600px"></div>
    <h1>Geolocation API(watchPosition/clearWatch) Sample</h1>
    <button onclick="start()">位置情報監視開始(watchPosition)</button>
    <button onclick="stop()">位置情報監視停止(clearWatch)</button>
    <div id="message"></div>
</body>
</html>
